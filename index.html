<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Viller's Bingo Bongo</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Fredericka+the+Great&display=swap" rel="stylesheet">
    </head>
    <body>
        <div style="font: 0px 'Fredericka the Great', cursive;">Font loader</div>
        <form id="bongoForm">
            <textarea id="bingoOptions" name="options" style="width: 600px; height: 400px;"></textarea><br />
            <button type="submit">Bongo!</button>
        </form>
        <p id="renderError" style="color: red; font-weight: bold;"></p>
        <div style="width: 600px; resize: horizontal; overflow: scroll;">
            <canvas id="cardCanvas" style="width: 100%"></canvas>
        </div>
        <script>
            /** @type {HTMLCanvasElement} */
            const cardCanvas = document.getElementById('cardCanvas');
            const cardContext = cardCanvas.getContext('2d');
            const backgroundImage = document.createElement('img');
            const bingoOptions = document.getElementById('bingoOptions');
            const bongoForm = document.getElementById('bongoForm');
            const renderError = document.getElementById('renderError');

            // Configurable:
            backgroundImage.src = 'template.jpg';
            const startX = 68;
            const startY = 330;
            const tileSize = 169;
            const tileSpacing = 37;
            const fontSize = tileSize / 6;

            function prefillOptions() {
                const prefillOptions = [
                    'Kabouter Plop - Kabouterdans',
                    'George Baker Selection - Una Paloma Blanca',
                    'Gebroeders Ko - Toeter Op M\'n Waterscooter',
                    'Cyndi Lauper - Girls Just Want to Have Fun',
                    'Five - Everybody Get Up',
                    'Toy-Box - Tarzan & Jane',
                    'O-Zone - Dragonstea Din Tei',
                    'Bassie & Adriaan - Hallo Vriendjes',
                    'K-otic - Damn (I Think I Love You)',
                    'Marianne Rosenberg - Ich Bin Wie Du',
                    'Paul de Leeuw - Vlieg Met Me Mee',
                    'Wham! - Wake Me Up Before You Go-Go',
                    'Jody Bernal - Que Si, Que No',
                    'De Jeugd van Tegenwoordig - Sterrenstof',
                    'Jason Paige - Pokémon Theme Song',
                    'André Hazes - Leef',
                    'AC/DC - Thunderstruck',
                    '"Weird Al" Yankovic - NOW That\'s What I call Polka!',
                    'The Swedish Chef - Popcorn',
                    'Rednex - Cotton Eye Joe',
                    'Gigi D\'Agostino - L\'Amours Toujours',
                    'Anita Meyer - Why Tell Me Why',
                    'Village People - YMCA',
                    'Vinzzent - Dromendans',
                ];
                bingoOptions.value = prefillOptions.join('\n');
            }

            /**
             * Splits text very subjectively.
             * 
             * @param {string} text
             * @param {number} [maxLines]
             * @return {string[]}
             */
            function splitText(text, maxLines) {
                let lines = [text.replace(/\s+/, ' ').trim()];
                let linesLeft = maxLines - 1;

                // Split standalone separators.
                const split = text.split(/ (\W) /);
                if (split.length <= maxLines) {
                    lines = split;
                }

                while (lines.length < maxLines) {
                    // Split longest splittable line (long enough and cointains space).
                    const splitLine = lines
                        .filter((line) => line.length >= 12 && line.match(/ /) !== null)
                        .reduce((previous, current) => {
                            if (previous === null) {
                                return current;
                            }

                            return current.length > previous.length ? current : previous;
                        }, null);

                    if (splitLine !== null) {
                        lines = lines.map((line) => {
                            if (line !== splitLine) {
                                return line;
                            }

                            // Split line into two balanced groups, preferring the first part.
                            const words = line.split(/ /);
                            let part1 = words[0];
                            let part2 = words.slice(1).join(' ');
                            while (part1.length < part2.length && part2.match(/ /) !== null) {
                                const part2Words = part2.split(/ /);
                                part1 += ` ${part2Words[0]}`;
                                part2 = part2Words.slice(1).join(' ');
                            }
                            
                            return [part1, part2];
                        }).flat();
                        continue;
                    }

                    // No more splits possible. End.
                    break;
                }             
                
                return lines;
            }

            function renderBackground() {
                cardCanvas.width = backgroundImage.width;
                cardCanvas.height = backgroundImage.height;
                
                cardContext.drawImage(backgroundImage, 0, 0);
            }

            function renderTiles() {
                renderBackground();

                if (options.length < 24) {
                    renderError.innerText = `Not enough options! ${options.length} out of 24 required.`;
                    return;
                }

                renderError.innerText = '';

                for (let tileId = 0; tileId < 25; tileId++) {
                    if (tileId === 12) {
                        continue;
                    }

                    const tileX = startX + ((tileSize + tileSpacing) * (tileId % 5));
                    const tileY = startY + ((tileSize + tileSpacing) * Math.floor(tileId / 5));

                    // cardContext.strokeStyle = 'lime';
                    // cardContext.lineWidth = 2;
                    // cardContext.strokeRect(tileX, tileY, tileSize, tileSize);

                    cardContext.textAlign = 'center';
                    cardContext.textBaseline = 'middle';
                    cardContext.fillStyle = 'black';
                    cardContext.font = `${fontSize}px 'Fredericka the Great', cursive`;

                    if (options.length > 0) {
                        const lines = splitText(options[tileId % options.length], 6);
                        let lineY = (tileY + (tileSize / 2)) - ((lines.length - 1) / 2) * fontSize;
                        lines.forEach((line) => {
                            cardContext.fillText(line, tileX + (tileSize / 2), lineY, tileSize);
                            lineY += fontSize;
                        });    
                    }
                }
            }

            backgroundImage.addEventListener('load', () => {
                document.fonts.ready.then(() => {
                    if (!document.fonts.check(`0 'Fredericka the Great'`)) {
                        console.error('Failed to load font!');
                    }

                    renderBackground();
                });
            });

            bongoForm.addEventListener('submit', (e) => {
                e.preventDefault(true);
                const formData = new FormData(bongoForm);
                options = formData.get('options')
                    .split(/\n/)
                    .map((line) => line.trim())
                    .filter((line) => line !== '');
                    renderTiles();	
            });

            prefillOptions();
        </script>
    </body>
</html>
