<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Viller's Bingo Bongo</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Cabin+Sketch:wght@700&display=swap" rel="stylesheet">
    </head>
    <body>
        <div style="font: 0px 'Cabin Sketch', cursive;">Font loader</div>
        <div style="width: 500px; display: inline-block; vertical-align: top;">
            <form id="bongoForm">
                <fieldset>
                    <legend>Design</legend>
                    <label>
                        Background:
                        <input type="file" id="backgroundImageInput" accept="image/*">
                    </label><br />
                    <label>
                        Free spot:
                        <input type="file" id="freeSpotImageInput" accept="image/*">
                    </label><br />
                    <label>
                        StartX:
                        <input type="number" name="startX" min="0" max="500" step="1" value="68" />
                    </label><br />
                    <label>
                        StartY:
                        <input type="number" name="startY" min="0" max="500" step="1" value="330" />
                    </label><br />
                    <label>
                        Tile size:
                        <input type="number" name="tileSize" min="0" max="500" step="1" value="169" />
                    </label><br />
                    <button type="button" id="overlayButton" style="float: right;">Toggle debug overlay</button>
                    <label>
                        Tile spacing:
                        <input type="number" name="tileSpacing" min="0" max="500" step="1" value="37" />
                    </label><br />
                </fieldset>
                <fieldset>
                    <legend>Options</legend>
                    <label>
                        Options (one per line):<br />
                        <textarea
                            name="options"
                            id="optionsInput"
                            style="width: 100%; height: 400px; resize: vertical;"
                        ></textarea>
                    </label><br />
                    <label>
                        Seed:
                        <input type="text" name="seed" id="seedInput" placeholder="Random!" />
                    </label>
                    <button type="button" id="bongoButton">Bongo!</button>
                </fieldset>
            </form>
        </div>
        <div style="width: 517px; resize: horizontal; overflow: scroll; display: inline-block; vertical-align: top;">
            <fieldset>
                <legend>Preview (save for full size)</legend>
                <canvas id="cardCanvas" width="1127" height="1600" style="width: 100%;"></canvas>
            </fieldset>
        </div>
        <script>
            // TODO: Packing, auto refresh, local storage, font

            /** @type {HTMLCanvasElement} */
            const cardCanvas = document.getElementById('cardCanvas');
            const cardContext = cardCanvas.getContext('2d');

            const bongoForm = document.getElementById('bongoForm');
            const bongoButton = document.getElementById('bongoButton');
            const overlayButton = document.getElementById('overlayButton');
            const seedInput = document.getElementById('seedInput');

            const backgroundImageInput = document.getElementById('backgroundImageInput');
            const freeSpotImageInput = document.getElementById('freeSpotImageInput');
 
            /** @type {HTMLImageElement|null} */
            let backgroundImage = null;
            /** @type {HTMLImageElement|null} */
            let freeSpotImage = null;

            let overlayEnabled = false;
            let fontLoaded = false;
            let fallbackSeed = createRandomSeed();

            /**
             * @param {File} file
             * @returns {Promise<HTMLImageElement>}
             */
            function loadImage(file) {
                const fileReader = new FileReader();
                fileReader.readAsDataURL(file);

                return new Promise((resolve, reject) => {
                    fileReader.addEventListener('load', () => {
                        const image = document.createElement('img');
                        image.src = fileReader.result;
                        image.addEventListener('load', () => {
                            resolve(image);
                        });
                        image.addEventListener('error', () => {
                            reject('Could not load image!');
                        });
                    })
                    fileReader.addEventListener('error', () => {
                        reject('Could not read file!');
                    });
                });
            }

            /**
             * https://stackoverflow.com/a/47593316
             * 
             * @param {string} seed
             */
            function createRandom(seed) {
                function xmur3(str) {
                    let h = 1779033703 ^ str.length;
                    for (let i = 0; i < str.length; i++) {
                        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
                        h = h << 13 | h >>> 19;
                    }
                    return function() {
                        h = Math.imul(h ^ (h >>> 16), 2246822507);
                        h = Math.imul(h ^ (h >>> 13), 3266489909);
                        return (h ^= h >>> 16) >>> 0;
                    }
                }
                function sfc32(a, b, c, d) {
                    return function() {
                        a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0; 
                        let t = (a + b) | 0;
                        a = b ^ b >>> 9;
                        b = c + (c << 3) | 0;
                        c = (c << 21 | c >>> 11);
                        d = d + 1 | 0;
                        t = t + d | 0;
                        c = c + t | 0;
                        return (t >>> 0) / 4294967296;
                    }
                }

                seed = xmur3(seed);
                return sfc32(seed(), seed(), seed(), seed());
            }

            function createRandomSeed() {
                const seedCharacters = 'abcdefghijklmnopqrstuvwxyz0123456789';
                let seed = ''
                for (let i = 0; i < 8; i++) {
                    seed += seedCharacters[Math.floor(Math.random() * seedCharacters.length)]
                }

                return seed;
            }

            /**
             * Splits text very subjectively.
             * 
             * @param {string} text
             * @param {number} [maxLines]
             */
            function splitText(text, maxLines) {
                let lines = [text.replace(/\s+/, ' ').trim()];
                let linesLeft = maxLines - 1;

                // Split standalone separators.
                const split = text.split(/ (\W) /);
                if (split.length <= maxLines) {
                    lines = split;
                }

                while (lines.length < maxLines) {
                    // Split longest splittable line (long enough and cointains space).
                    const splitLine = lines
                        .filter((line) => line.length >= 12 && line.match(/ /) !== null)
                        .reduce((previous, current) => {
                            if (previous === null) {
                                return current;
                            }

                            return current.length > previous.length ? current : previous;
                        }, null);

                    if (splitLine !== null) {
                        lines = lines.map((line) => {
                            if (line !== splitLine) {
                                return line;
                            }

                            // Split line into two balanced groups, preferring the first part.
                            const words = line.split(/ /);
                            let part1 = words[0];
                            let part2 = words.slice(1).join(' ');
                            while (part1.length < part2.length && part2.match(/ /) !== null) {
                                const part2Words = part2.split(/ /);
                                part1 += ` ${part2Words[0]}`;
                                part2 = part2Words.slice(1).join(' ');
                            }
                            
                            return [part1, part2];
                        }).flat();
                        continue;
                    }

                    // No more splits possible. End.
                    break;
                }             
                
                return lines;
            }

            function render() {
                // Parse form values.
                const formData = new FormData(bongoForm);

                const startX = Number(formData.get('startX'));
                const startY = Number(formData.get('startY'));
                const tileSize = Number(formData.get('tileSize'));
                const tileSpacing = Number(formData.get('tileSpacing'));
                const options = formData.get('options').split(/\n/).filter((line) => line.trim().length > 0);
                const seed = (formData.get('seed') || fallbackSeed);

                const fontSize = (tileSize / 6);
                const width = (backgroundImage?.width ?? cardCanvas.width);
                const height = (backgroundImage?.height ?? cardCanvas.height);

                cardCanvas.width = width;
                cardCanvas.height = height;

                if (backgroundImage) {
                    cardContext.drawImage(backgroundImage, 0, 0);
                }

                // Debug information.
                if (overlayEnabled) {
                    cardContext.font = '20px sans-serif';
                    cardContext.fillStyle = 'black';
                    cardContext.textBaseline = 'top';
                    cardContext.textAlign = 'right';
                    let debugTextY = 10;

                    /** @param {string} message */
                    function drawDebugMessage(message) {
                        cardContext.fillText(message, width - 10, debugTextY);
                        debugTextY += 22;
                    }

                    drawDebugMessage('Viller\'s Bingo Bongo v0.2');
                    drawDebugMessage(`Seed: ${seed}`);

                    if (!backgroundImage) {
                        drawDebugMessage('No background image!');
                    }
                    if (!fontLoaded) {
                        drawDebugMessage('Font not loaded!');
                    }
                    if (options.length < 24) {
                        drawDebugMessage(`Not enough options (${options.length}/24)!`);
                    }
                }

                // Shuffle and limit options.
                const random = createRandom(seed);
                let remainingOptions = [...options];
                const shuffledOptions = [];
                while (remainingOptions.length > 0 && shuffledOptions.length < 24) {
                    shuffledOptions.push(remainingOptions.splice(Math.floor(random() * remainingOptions.length), 1)[0]);
                }

                // Draw tiles.
                cardContext.textAlign = 'center';
                cardContext.textBaseline = 'middle';
                cardContext.fillStyle = 'black';
                cardContext.font = `${fontSize}px 'Cabin Sketch', cursive`;
                
                for (let tileId = 0; tileId < 25; tileId++) {
                    const tileX = startX + ((tileSize + tileSpacing) * (tileId % 5));
                    const tileY = startY + ((tileSize + tileSpacing) * Math.floor(tileId / 5));

                    if (tileId === 12) {
                        // Draw free spot image.
                        if (freeSpotImage) {
                            cardContext.drawImage(freeSpotImage, tileX, tileY, tileSize, tileSize);
                        }
                        continue;
                    }

                    if (overlayEnabled) {
                        cardContext.strokeStyle = 'lime';
                        cardContext.lineWidth = 1;
                        cardContext.strokeRect(tileX, tileY, tileSize, tileSize);
                    }

                    const optionIndex = (tileId < 12 ? tileId : tileId -1);
                    if (optionIndex < shuffledOptions.length) {
                        const lines = splitText(shuffledOptions[optionIndex], 6);
                        let lineY = (tileY + (tileSize / 2)) - ((lines.length - 1) / 2) * fontSize;
                        lines.forEach((line) => {
                            cardContext.fillText(line, tileX + (tileSize / 2), lineY, tileSize);
                            lineY += fontSize;
                        });
                    }
                }
            }

            // Event listeners
            bongoForm.addEventListener('change', () => render());

            document.fonts.ready.then(() => {
                if (!document.fonts.check(`0 'Fredericka the Great'`)) {
                    console.error('Failed to load font!');
                    return;
                }

                fontLoaded = true;
            });

            bongoForm.addEventListener('submit', (event) => {
                event.preventDefault();
                render();
            });

            overlayButton.addEventListener('click', () => {
                overlayEnabled = !overlayEnabled;
                render();
            });

            bongoButton.addEventListener('click', () => {
                // Force refresh fallback seed so it stays the same unless the power of the bongo is wielded.
                fallbackSeed = createRandomSeed();
                render();
            });

            backgroundImageInput.addEventListener('change', async () => {
                backgroundImage = await loadImage(backgroundImageInput.files[0]);
                render();
            });
            freeSpotImageInput.addEventListener('change', async () => {
                freeSpotImage = await loadImage(freeSpotImageInput.files[0]);
                render();
            });

            const prefillOptions = [
                'Kabouter Plop - Kabouterdans',
                'George Baker Selection - Una Paloma Blanca',
                'Gebroeders Ko - Toeter Op M\'n Waterscooter',
                'Cyndi Lauper - Girls Just Want to Have Fun',
                'Five - Everybody Get Up',
                'Toy-Box - Tarzan & Jane',
                'O-Zone - Dragonstea Din Tei',
                'Bassie & Adriaan - Hallo Vriendjes',
                'K-otic - Damn (I Think I Love You)',
                'Marianne Rosenberg - Ich Bin Wie Du',
                'Paul de Leeuw - Vlieg Met Me Mee',
                'Wham! - Wake Me Up Before You Go-Go',
                'Jody Bernal - Que Si, Que No',
                'De Jeugd van Tegenwoordig - Sterrenstof',
                'Jason Paige - Pokémon Theme Song',
                'André Hazes - Leef',
                'AC/DC - Thunderstruck',
                '"Weird Al" Yankovic - NOW That\'s What I call Polka!',
                'The Swedish Chef - Popcorn',
                'Rednex - Cotton Eye Joe',
                'Gigi D\'Agostino - L\'Amours Toujours',
                'Anita Meyer - Why Tell Me Why',
                'Village People - YMCA',
                'Vinzzent - Dromendans',
            ];
            optionsInput.value = prefillOptions.join('\n');
        </script>
    </body>
</html>
