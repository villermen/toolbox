<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Viller's Bingo Bongo</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Fredericka+the+Great&display=swap" rel="stylesheet">
    </head>
    <body>
        <div style="font: 0px 'Fredericka the Great', cursive;">Font loader</div>
        <form id="bongoForm">
            <textarea name="options" style="width: 600px; height: 100px;">
                Kabouter Plop - Kabouterdans
                George Baker Selection - Una Paloma Blanca
                Gebroeders Ko - Toeter Op M'n Waterscooter
                Cyndi Lauper - Girls Just Want to Have Fun
                Five - Everybody Get Up
            </textarea><br />
            <button type="submit">Bongo!</button>
        </form>
        <br />
        <canvas id="cardCanvas" style="max-width: 600px;"></canvas>
        <script>
            /** @type {HTMLCanvasElement} */
            const cardCanvas = document.getElementById('cardCanvas');
            const cardContext = cardCanvas.getContext('2d');
            const backgroundImage = document.createElement('img');
            const bingoOptionsElement = document.getElementById('bingoOptions');
            const bongoForm = document.getElementById('bongoForm');

            // Configurable:
            backgroundImage.src = 'template.jpg';
            const startX = 68;
            const startY = 330;
            const tileSize = 169;
            const tileSpacing = 37;
            const fontSize = tileSize / 6;
            let options = [];

            /**
             * Splits text very subjectively.
             * 
             * @param {string} text
             * @param {number} [maxLines]
             * @return {string[]}
             */
            function splitText(text, maxLines) {
                let lines = [text.trim()];
                let linesLeft = maxLines - 1;

                // Split standalone separators.
                const split = text.split(/\s+(\W)\s+/).filter((linePart) => linePart !== '');
                if (split.length <= maxLines) {
                    lines = split;
                }

                while (lines.length < maxLines) {
                    // Split longest splittable line.
                    const splitLine = lines
                        .filter((line) => line.match(/\s/))
                        .reduce((previous, current) => {
                            if (previous === null) {
                                return current;
                            }

                            return current.length > previous.length ? current : previous;
                        }, null);
                    if (splitLine !== null) {
                        lines = lines.map((line) => {
                            if (line !== splitLine) {
                                return line;
                            }

                            // TODO: Ugly for consecutive small words. Prefer splitting out large words?

                            const matches = line.match(/^(.*?)\s+([^\s]+)$/);
                            return [matches[1], matches[2]];
                        }).flat();
                        continue;
                    }

                    // No more splits possible. End.
                    break;
                }             
                
                return lines;
            }

            function draw() {
                cardCanvas.width = backgroundImage.width;
                cardCanvas.height = backgroundImage.height;
                
                cardContext.drawImage(backgroundImage, 0, 0);

                for (let tileId = 0; tileId < 25; tileId++) {
                    const tileX = startX + ((tileSize + tileSpacing) * (tileId % 5));
                    const tileY = startY + ((tileSize + tileSpacing) * Math.floor(tileId / 5));

                    cardContext.strokeStyle = 'lime';
                    cardContext.lineWidth = 2;
                    cardContext.textAlign = 'center';
                    cardContext.textBaseline = 'top';
                    cardContext.fillStyle = 'black';
                    cardContext.strokeRect(tileX, tileY, tileSize, tileSize);
                    cardContext.font = `${fontSize}px 'Fredericka the Great', cursive`;

                    if (options.length > 0) {
                        const lines = splitText(options[tileId % options.length], 6);
                        let lineY = (tileY + (tileSize / 2) - Math.ceil((lines.length - 1) / 2) * fontSize);
                        lines.forEach((line) => {
                            cardContext.fillText(line, tileX + (tileSize / 2), lineY, tileSize);
                            lineY += fontSize;
                        });    
                    }
                }
            }

            backgroundImage.addEventListener('load', () => {
                document.fonts.ready.then(() => {
                    if (!document.fonts.check(`0 'Fredericka the Great'`)) {
                        console.error('Failed to load font!');
                    }

                    draw();
                });
            });

            bongoForm.addEventListener('submit', (e) => {
                e.preventDefault(true);
                const formData = new FormData(bongoForm);
                options = formData.get('options')
                    .split(/\n/)
                    .map((line) => line.trim())
                    .filter((line) => line !== '');
                draw();	
            });
        </script>
    </body>
</html>
